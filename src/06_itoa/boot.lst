     1                                          BOOT_LOAD       equ     0x7C00
     2                                          ORG     BOOT_LOAD
     3                                  
     4                                  ;マクロ
     5                                  
     6                                  %include        "../include/macro.s"
     1                              <1> %macro      cdecl 1-*.nolist
     2                              <1> 
     3                              <1>     %rep    %0 - 1
     4                              <1>         push    %{-1:-1}
     5                              <1>         %rotate -1
     6                              <1>     %endrep
     7                              <1>     %rotate -1
     8                              <1> 
     9                              <1>         call    %1
    10                              <1> 
    11                              <1>     %if 1 < %0
    12                              <1>         add     sp, (__BITS__>>3) * (%0 - 1)
    13                              <1>     %endif
    14                              <1> 
    15                              <1> %endmacro
     7                                  
     8                                  ;エントリーポイント
     9                                  
    10                                  entry:
    11 00000000 EB5A                            jmp     ipl
    12 00000002 90<rept>                        times 90 - ($ - $$) db 0x90
    13 0000005A 55AA                            db 0x55, 0xAA
    14                                  
    15                                  ipl:
    16 0000005C FA                              cli
    17                                  
    18 0000005D B80000                          mov     ax, 0x0000
    19 00000060 8ED8                            mov     ds, ax
    20 00000062 8EC0                            mov     es, ax
    21 00000064 8ED0                            mov     ss, ax
    22 00000066 BC007C                          mov     sp, BOOT_LOAD
    23                                  
    24 00000069 FB                              sti
    25                                  
    26 0000006A 8816[1601]                      mov     [BOOT.DRIVE], dl
    27                                  
    28 0000006E 68[FE00]E8A40083C4-             cdecl   puts, .s0               ;文字列を表示
    28 00000076 02                 
    29 00000077 6A016A0A6A0868-                 cdecl   itoa, 8086, .s1, 8, 10, 0b0001
    29 0000007E [0B01]68961FE8B100-
    29 00000086 83C40A             
    30 00000089 68[0B01]E8890083C4-             cdecl   puts, .s1
    30 00000091 02                 
    31                                  
    32 00000092 6A036A0A6A0868-                 cdecl   itoa, 8086, .s1, 8, 10, 0b0011
    32 00000099 [0B01]68961FE89600-
    32 000000A1 83C40A             
    33 000000A4 68[0B01]E86E0083C4-             cdecl   puts, .s1
    33 000000AC 02                 
    34                                  
    35 000000AD 6A006A0A6A0868-                 cdecl   itoa, -1, .s1, 8, 10, 0b0000
    35 000000B4 [0B01]6AFFE87C0083-
    35 000000BC C40A               
    36 000000BE 68[0B01]E8540083C4-             cdecl   puts, .s1
    36 000000C6 02                 
    37                                          
    38 000000C7 6A006A106A0868-                 cdecl   itoa, -1, .s1, 8, 16, 0b0000
    38 000000CE [0B01]6AFFE8620083-
    38 000000D6 C40A               
    39 000000D8 68[0B01]E83A0083C4-             cdecl   puts, .s1
    39 000000E0 02                 
    40                                  
    41 000000E1 6A016A0A6A0868-                 cdecl   itoa, 8086, .s1, 8, 10, 0b0001
    41 000000E8 [0B01]68961FE84700-
    41 000000F0 83C40A             
    42 000000F3 68[0B01]E81F0083C4-             cdecl   puts, .s1
    42 000000FB 02                 
    43                                  
    44                                          
    45                                  
    46 000000FC EBFE                            jmp     $
    47                                  
    48                                  ;データ
    49                                  
    50 000000FE 426F6F74696E672E2E-     .s0     db      "Booting...", 0x0A, 0x0D, 0
    50 00000107 2E0A0D00           
    51 0000010B 2D2D2D2D2D2D2D2D0A-     .s1     db      "--------", 0x0A, 0x0D, 0
    51 00000114 0D00               
    52                                  
    53                                  ALIGN 2, db 0
    54                                  BOOT:
    55 00000116 0000                     .DRIVE:        dw 0
    56                                  
    57                                  ; モジュール
    58                                  
    59                                  %include    "../modules/real/puts.s"
     1                              <1> puts:
     2 00000118 55                  <1>         push    bp
     3 00000119 89E5                <1>         mov     bp, sp
     4                              <1> 
     5 0000011B 50                  <1>         push    ax
     6 0000011C 53                  <1>         push    bx
     7 0000011D 56                  <1>         push    si
     8                              <1> 
     9 0000011E 8B7604              <1>         mov     si, [bp + 4]
    10                              <1> 
    11 00000121 B40E                <1>         mov     ah, 0x0e
    12 00000123 BB0000              <1>         mov     bx, 0x0000
    13 00000126 FC                  <1>         cld
    14                              <1> .10L:
    15                              <1> 
    16 00000127 AC                  <1>         lodsb
    17                              <1> 
    18 00000128 3C00                <1>         cmp     al, 0
    19 0000012A 7404                <1>         je      .10E
    20                              <1> 
    21 0000012C CD10                <1>         int     0x10
    22 0000012E EBF7                <1>         jmp     .10L
    23                              <1> .10E:
    24                              <1> 
    25 00000130 5E                  <1>         pop     si
    26 00000131 5B                  <1>         pop     bx
    27 00000132 58                  <1>         pop     ax
    28                              <1> 
    29 00000133 89EC                <1>         mov     sp, bp
    30 00000135 5D                  <1>         pop     bp
    31                              <1> 
    32 00000136 C3                  <1>         ret
    60                                  %include    "../modules/real/itoa.s"
     1                              <1> itoa:
     2 00000137 55                  <1>         push    bp
     3 00000138 89E5                <1>         mov     bp, sp
     4                              <1> 
     5 0000013A 50                  <1>         push    ax
     6 0000013B 53                  <1>         push    bx
     7 0000013C 51                  <1>         push    cx
     8 0000013D 52                  <1>         push    dx
     9 0000013E 56                  <1>         push    si
    10 0000013F 57                  <1>         push    di
    11                              <1> 
    12                              <1> ;引数を取得
    13                              <1> 
    14 00000140 8B4604              <1>         mov     ax, [bp + 4]        ; 数値
    15 00000143 8B7606              <1>         mov     si, [bp + 6]        ; バッファアドレス
    16 00000146 8B4E08              <1>         mov     cx, [bp + 8]        ;バッファサイズ
    17                              <1> 
    18 00000149 89F7                <1>         mov     di, si
    19 0000014B 01CF                <1>         add     di, cx
    20 0000014D 4F                  <1>         dec     di      ;バッファの最後尾
    21                              <1> 
    22 0000014E 8B5E0C              <1>         mov     bx, word[bp + 12] ;flags = オプション
    23                              <1> 
    24                              <1> ;符号付き判定
    25                              <1> 
    26 00000151 F7C30100            <1>         test    bx, 0b001
    27 00000155 7408                <1> .10Q:   je      .10E
    28 00000157 83F800              <1>         cmp     ax, 0
    29 0000015A 7D03                <1> .12Q:   jge     .12E
    30 0000015C 83CB02              <1>         or      bx, 0b0010
    31                              <1> .12E:
    32                              <1> .10E:
    33                              <1> 
    34                              <1> ;符号出力判定
    35                              <1> 
    36 0000015F F7C30200            <1>         test    bx, 0b0010
    37 00000163 7410                <1> .20Q:   je      .20E
    38 00000165 83F800              <1>         cmp     ax, 0
    39 00000168 7D07                <1> .22Q:   jge     .22F
    40 0000016A F7D8                <1>         neg     ax
    41 0000016C C6042D              <1>         mov     [si], byte '-'   ;先頭にマイナスを表示
    42 0000016F EB03                <1>         jmp     .22E
    43                              <1> .22F:   
    44                              <1> 
    45 00000171 C6042B              <1>         mov     [si], byte '+'  ;先頭にプラスを表示
    46                              <1> 
    47                              <1> .22E:   
    48 00000174 49                  <1>         dec     cx
    49                              <1> 
    50                              <1> .20E:
    51                              <1> 
    52                              <1> ; ASCII変換
    53 00000175 8B5E0A              <1>         mov bx, [bp + 10]        ;基数
    54                              <1> 
    55                              <1> .30L:
    56 00000178 BA0000              <1>         mov     dx, 0                   ;基数で割ることによって基数に合わせた数値にする
    57 0000017B F7F3                <1>         div     bx                     ; dx = dx:ax % bx
    58                              <1> 
    59 0000017D 89D6                <1>         mov     si, dx                              
    60 0000017F 8A94[A701]          <1>         mov     dl, byte [.ascii + si]
    61                              <1> 
    62 00000183 8815                <1>         mov     [di], dl                ;diは一番うしろの数値のアドレス
    63 00000185 4F                  <1>         dec     di
    64                              <1> 
    65 00000186 83F800              <1>         cmp     ax, 0
    66 00000189 E0ED                <1>         loopnz  .30L
    67                              <1> .30E:
    68                              <1> 
    69                              <1> ;空欄を埋める
    70                              <1> 
    71 0000018B 83F900              <1>         cmp     cx, 0
    72 0000018E 740D                <1> .40Q:   je      .40E
    73 00000190 B020                <1>         mov     al, ' '
    74 00000192 837E0C04            <1>         cmp     [bp + 12], word 0b0100             ;フラグ
    75 00000196 7502                <1> .42Q:   jne     .42E
    76 00000198 B030                <1>         mov     al, '0'
    77                              <1> .42E:
    78 0000019A FD                  <1>         std
    79 0000019B F3AA                <1>         rep stosb
    80                              <1> .40E:
    81                              <1> 
    82                              <1> ;レジスタ復帰とスタックフレームの廃棄
    83                              <1> 
    84 0000019D 5F                  <1>         pop     di
    85 0000019E 5E                  <1>         pop     si
    86 0000019F 5A                  <1>         pop     dx 
    87 000001A0 59                  <1>         pop     cx
    88 000001A1 5B                  <1>         pop     bx
    89 000001A2 58                  <1>         pop     ax
    90                              <1> 
    91 000001A3 89EC                <1>         mov     sp, bp
    92 000001A5 5D                  <1>         pop     bp
    93                              <1> 
    94 000001A6 C3                  <1>         ret
    95                              <1> 
    96 000001A7 303132333435363738- <1> .ascii:  db      "0123456789ABCDEF"          ;変換テーブル
    96 000001B0 39414243444546      <1>
    61                                  
    62                                  
    63                                  ;ブートフラグ
    64                                  
    65 000001B7 00<rept>                        times 510 - ($ - $$) db 0x00
    66 000001FE 55AA                            db 0x55, 0xAA        
