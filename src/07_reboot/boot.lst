     1                                          BOOT_LOAD       equ     0x7C00  
     2                                          ORG     BOOT_LOAD
     3                                  
     4                                  ;マクロ
     5                                  
     6                                  %include        "../include/macro.s"
     1                              <1> %macro      cdecl 1-*.nolist
     2                              <1> 
     3                              <1>     %rep    %0 - 1
     4                              <1>         push    %{-1:-1}
     5                              <1>         %rotate -1
     6                              <1>     %endrep
     7                              <1>     %rotate -1
     8                              <1> 
     9                              <1>         call    %1
    10                              <1> 
    11                              <1>     %if 1 < %0
    12                              <1>         add     sp, (__BITS__>>3) * (%0 - 1)
    13                              <1>     %endif
    14                              <1> 
    15                              <1> %endmacro
     7                                  
     8                                  ;エントリーポイント
     9                                  
    10                                  entry:
    11 00000000 EB5A                            jmp     ipl
    12 00000002 90<rept>                        times 90 - ($ - $$) db 0x90
    13 0000005A 55AA                            db 0x55, 0xAA
    14                                  
    15                                  ipl:
    16 0000005C FA                              cli
    17                                  
    18 0000005D B80000                          mov     ax, 0x0000
    19 00000060 8ED8                            mov     ds, ax
    20 00000062 8EC0                            mov     es, ax
    21 00000064 8ED0                            mov     ss, ax
    22 00000066 BC007C                          mov     sp, BOOT_LOAD
    23                                  
    24 00000069 FB                              sti
    25                                  
    26 0000006A 8816[B000]                      mov     [BOOT.DRIVE], dl
    27                                  
    28                                  ;文字列を表示
    29 0000006E 68[9700]E83E0083C4-             cdecl   puts, .s0              
    29 00000076 02                 
    30 00000077 6A016A0A6A0868-                 cdecl   itoa, 8086, .s1, 8, 10, 0b0001
    30 0000007E [A400]68961FE84B00-
    30 00000086 83C40A             
    31 00000089 68[A400]E8230083C4-             cdecl   puts, .s1
    31 00000091 02                 
    32                                  
    33 00000092 E8BC00                          cdecl   reboot
    34                                  
    35                                          
    36                                  ;処理をループすることによって停止させる
    37 00000095 EBFE                            jmp     $
    38                                  
    39                                  ;データ
    40 00000097 426F6F74696E672E2E-     .s0     db      "Booting...", 0x0A, 0x0D, 0
    40 000000A0 2E0A0D00           
    41 000000A4 2D2D2D2D2D2D2D2D0A-     .s1     db      "--------", 0x0A, 0x0D, 0
    41 000000AD 0D00               
    42                                  
    43 000000AF 00                      ALIGN 2, db 0
    44                                  BOOT:
    45 000000B0 0000                     .DRIVE:        dw 0
    46                                  
    47                                  ; モジュール
    48                                  
    49                                  %include    "../modules/real/puts.s"
     1                              <1> puts:
     2 000000B2 55                  <1>         push    bp
     3 000000B3 89E5                <1>         mov     bp, sp
     4                              <1> 
     5 000000B5 50                  <1>         push    ax
     6 000000B6 53                  <1>         push    bx
     7 000000B7 56                  <1>         push    si
     8                              <1> 
     9 000000B8 8B7604              <1>         mov     si, [bp + 4]
    10                              <1> 
    11 000000BB B40E                <1>         mov     ah, 0x0e
    12 000000BD BB0000              <1>         mov     bx, 0x0000
    13 000000C0 FC                  <1>         cld
    14                              <1> .10L:
    15                              <1> 
    16 000000C1 AC                  <1>         lodsb
    17                              <1> 
    18 000000C2 3C00                <1>         cmp     al, 0
    19 000000C4 7404                <1>         je      .10E
    20                              <1> 
    21 000000C6 CD10                <1>         int     0x10
    22 000000C8 EBF7                <1>         jmp     .10L
    23                              <1> .10E:
    24                              <1> 
    25 000000CA 5E                  <1>         pop     si
    26 000000CB 5B                  <1>         pop     bx
    27 000000CC 58                  <1>         pop     ax
    28                              <1> 
    29 000000CD 89EC                <1>         mov     sp, bp
    30 000000CF 5D                  <1>         pop     bp
    31                              <1> 
    32 000000D0 C3                  <1>         ret
    50                                  %include    "../modules/real/itoa.s"
     1                              <1> itoa:
     2 000000D1 55                  <1>         push    bp
     3 000000D2 89E5                <1>         mov     bp, sp
     4                              <1> 
     5 000000D4 50                  <1>         push    ax
     6 000000D5 53                  <1>         push    bx
     7 000000D6 51                  <1>         push    cx
     8 000000D7 52                  <1>         push    dx
     9 000000D8 56                  <1>         push    si
    10 000000D9 57                  <1>         push    di
    11                              <1> 
    12                              <1> ;引数を取得
    13                              <1> 
    14 000000DA 8B4604              <1>         mov     ax, [bp + 4]        ; 数値
    15 000000DD 8B7606              <1>         mov     si, [bp + 6]        ; バッファアドレス
    16 000000E0 8B4E08              <1>         mov     cx, [bp + 8]        ;バッファサイズ
    17                              <1> 
    18 000000E3 89F7                <1>         mov     di, si
    19 000000E5 01CF                <1>         add     di, cx
    20 000000E7 4F                  <1>         dec     di      ;バッファの最後尾
    21                              <1> 
    22 000000E8 8B5E0C              <1>         mov     bx, word[bp + 12] ;flags = オプション
    23                              <1> 
    24                              <1> ;符号付き判定
    25                              <1> 
    26 000000EB F7C30100            <1>         test    bx, 0b001
    27 000000EF 7408                <1> .10Q:   je      .10E
    28 000000F1 83F800              <1>         cmp     ax, 0
    29 000000F4 7D03                <1> .12Q:   jge     .12E
    30 000000F6 83CB02              <1>         or      bx, 0b0010
    31                              <1> .12E:
    32                              <1> .10E:
    33                              <1> 
    34                              <1> ;符号出力判定
    35                              <1> 
    36 000000F9 F7C30200            <1>         test    bx, 0b0010
    37 000000FD 7410                <1> .20Q:   je      .20E
    38 000000FF 83F800              <1>         cmp     ax, 0
    39 00000102 7D07                <1> .22Q:   jge     .22F
    40 00000104 F7D8                <1>         neg     ax
    41 00000106 C6042D              <1>         mov     [si], byte '-'   ;先頭にマイナスを表示
    42 00000109 EB03                <1>         jmp     .22E
    43                              <1> .22F:   
    44                              <1> 
    45 0000010B C6042B              <1>         mov     [si], byte '+'  ;先頭にプラスを表示
    46                              <1> 
    47                              <1> .22E:   
    48 0000010E 49                  <1>         dec     cx
    49                              <1> 
    50                              <1> .20E:
    51                              <1> 
    52                              <1> ; ASCII変換
    53 0000010F 8B5E0A              <1>         mov bx, [bp + 10]        ;基数
    54                              <1> 
    55                              <1> .30L:
    56 00000112 BA0000              <1>         mov     dx, 0                   ;基数で割ることによって基数に合わせた数値にする
    57 00000115 F7F3                <1>         div     bx                     ; dx = dx:ax % bx
    58                              <1> 
    59 00000117 89D6                <1>         mov     si, dx                              
    60 00000119 8A94[4101]          <1>         mov     dl, byte [.ascii + si]
    61                              <1> 
    62 0000011D 8815                <1>         mov     [di], dl                ;diは一番うしろの数値のアドレス
    63 0000011F 4F                  <1>         dec     di
    64                              <1> 
    65 00000120 83F800              <1>         cmp     ax, 0
    66 00000123 E0ED                <1>         loopnz  .30L
    67                              <1> .30E:
    68                              <1> 
    69                              <1> ;空欄を埋める
    70                              <1> 
    71 00000125 83F900              <1>         cmp     cx, 0
    72 00000128 740D                <1> .40Q:   je      .40E
    73 0000012A B020                <1>         mov     al, ' '
    74 0000012C 837E0C04            <1>         cmp     [bp + 12], word 0b0100             ;フラグ
    75 00000130 7502                <1> .42Q:   jne     .42E
    76 00000132 B030                <1>         mov     al, '0'
    77                              <1> .42E:
    78 00000134 FD                  <1>         std
    79 00000135 F3AA                <1>         rep stosb
    80                              <1> .40E:
    81                              <1> 
    82                              <1> ;レジスタ復帰とスタックフレームの廃棄
    83                              <1> 
    84 00000137 5F                  <1>         pop     di
    85 00000138 5E                  <1>         pop     si
    86 00000139 5A                  <1>         pop     dx 
    87 0000013A 59                  <1>         pop     cx
    88 0000013B 5B                  <1>         pop     bx
    89 0000013C 58                  <1>         pop     ax
    90                              <1> 
    91 0000013D 89EC                <1>         mov     sp, bp
    92 0000013F 5D                  <1>         pop     bp
    93                              <1> 
    94 00000140 C3                  <1>         ret
    95                              <1> 
    96 00000141 303132333435363738- <1> .ascii:  db      "0123456789ABCDEF"          ;変換テーブル
    96 0000014A 39414243444546      <1>
    51                                  %include    "../modules/real/reboot.s"
     1                              <1> reboot:
     2                              <1> 
     3 00000151 68[6D01]E85BFF83C4- <1>         cdecl   puts, .s0   ;メッセージの表示
     3 00000159 02                  <1>
     4                              <1> 
     5                              <1> ; キー入力待ち
     6                              <1> 
     7                              <1> .10L:
     8 0000015A B410                <1>         mov     ah, 0x10
     9 0000015C CD16                <1>         int     0x16
    10                              <1> 
    11 0000015E 3C20                <1>         cmp     al, ' '
    12 00000160 75F8                <1>         jne     .10L
    13                              <1> 
    14                              <1> ;改行を出力
    15 00000162 68[8B01]E84AFF83C4- <1>         cdecl   puts, .s1
    15 0000016A 02                  <1>
    16                              <1> 
    17                              <1> ;再起動
    18 0000016B CD19                <1>         int     0x19    ; BIOS(0x19)
    19                              <1> 
    20                              <1> ;文字列データ
    21 0000016D 0A0D50757368205350- <1> .s0     db      0x0A, 0x0D, "Push SPACE key to reboot...", 0
    21 00000176 414345206B65792074- <1>
    21 0000017F 6F207265626F6F742E- <1>
    21 00000188 2E2E00              <1>
    22 0000018B 0A0D0A0D00          <1> .s1     db      0x0A, 0x0D, 0x0A, 0x0D, 0
    52                                  
    53                                  ;ブートフラグ
    54                                  
    55 00000190 00<rept>                        times 510 - ($ - $$) db 0x00
    56 000001FE 55AA                            db 0x55, 0xAA        
